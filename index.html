<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Joc de l'Impostor - Edició Cyber</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
    :root {
        --bg-dark: #030712;
        --surface: #111827;
        --surface-highlight: #1f2937;
        --primary: #38bdf8;
        --primary-glow: rgba(56, 189, 248, 0.4);
        --text-main: #f3f4f6;
        --text-muted: #9ca3af;
        --border-color: rgba(255, 255, 255, 0.1);
        --impostor: #ff1e56;
        --impostor-bg: rgba(255, 30, 86, 0.15);
        --bufo: #d946ef;
        --bufo-bg: rgba(217, 70, 239, 0.15);
        --civilian: #00e676;
        --civilian-bg: rgba(0, 230, 118, 0.15);
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 12px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
        -webkit-user-select: none;
        user-select: none;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
        display: flex;
        justify-content: center;
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        touch-action: manipulation;
    }

    .glow-orb {
        position: fixed;
        width: 40vw;
        height: 40vw;
        border-radius: 50%;
        filter: blur(60px);
        z-index: -2;
        opacity: 0.15;
        animation: orbFloat 20s infinite ease-in-out alternate;
        pointer-events: none;
    }

    @keyframes orbFloat {
        0% { transform: translate(0, 0) scale(1); }
        100% { transform: translate(40px, -40px) scale(1.1); }
    }

    .app-container {
        width: 100%;
        max-width: 500px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        position: relative;
    }

    header {
        margin: 0.5rem 0 1.5rem;
        text-align: center;
    }

    .gradient-text {
        font-family: 'Outfit', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1;
        text-transform: uppercase;
        background: linear-gradient(135deg, #fff 30%, var(--text-muted));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        font-family: 'Outfit', sans-serif;
        color: var(--text-muted);
        text-align: center;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .screen {
        display: none;
        flex-direction: column;
        flex: 1;
        animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .screen.active {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .glass-card {
        background: rgba(17, 24, 39, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        margin-bottom: 1.25rem;
    }

    .glass-input, select.glass-input {
        background: var(--surface-highlight);
        border: 2px solid transparent;
        color: white;
        padding: 0.875rem;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 500;
        width: 100%;
        outline: none;
        transition: 0.2s;
        -webkit-appearance: none;
        appearance: none;
        min-height: 48px;
    }

    .glass-input:focus { border-color: var(--primary); background: var(--surface); }

    .range-input {
        width: 100%;
        accent-color: var(--primary);
        height: 6px;
        background: var(--surface-highlight);
        border-radius: 999px;
        appearance: none;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .btn {
        padding: 1rem 1.25rem;
        border-radius: var(--radius-md);
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-bottom: 0.75rem;
        min-height: 52px;
    }

    .btn.primary {
        background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
        color: white;
    }

    .btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: var(--text-main);
    }

    .btn.dashed {
        border: 2px dashed rgba(56, 189, 248, 0.4);
        background: rgba(56, 189, 248, 0.05);
        color: var(--primary);
    }

    .btn.danger {
        background: rgba(255, 30, 86, 0.15);
        color: var(--impostor);
        border: 1px solid rgba(255, 30, 86, 0.3);
    }

    .bottom-action {
        margin-top: auto;
        padding-top: 1rem;
        background: linear-gradient(to top, var(--bg-dark) 20%, transparent);
        position: sticky;
        bottom: 0;
        padding-bottom: 1rem;
    }

    .scroll-area {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding-bottom: 1rem;
        -webkit-overflow-scrolling: touch;
    }

    .player-input-row {
        display: flex;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
    }

    .btn-remove {
        width: 3.5rem;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 30, 86, 0.3);
        background: rgba(255, 30, 86, 0.15);
        color: var(--impostor);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        min-height: 48px;
        flex-shrink: 0;
    }

    .role-card {
        min-height: 380px;
        justify-content: center;
        align-items: center;
        text-align: center;
        border-width: 2px;
        position: relative;
    }

    .role-title {
        font-family: 'Outfit', sans-serif;
        font-size: 3rem;
        font-weight: 900;
        margin: 1rem 0;
        letter-spacing: -0.05em;
        text-shadow: 0 0 25px currentColor;
    }

    .word-display {
        font-family: monospace;
        font-size: 1.8rem;
        font-weight: 700;
        background: rgba(0,0,0,0.4);
        padding: 1rem;
        border-radius: var(--radius-sm);
        width: 100%;
        border: 1px dashed rgba(255,255,255,0.2);
        word-break: break-all;
        color: white;
    }

    .divider { width: 100%; height: 2px; background: currentColor; opacity: 0.3; margin: 1.25rem 0; }

    .role-impostor { border-color: var(--impostor); color: var(--impostor); background: radial-gradient(circle at top right, var(--impostor-bg), rgba(17, 24, 39, 0.95)); }
    .role-bufo { border-color: var(--bufo); color: var(--bufo); background: radial-gradient(circle at top right, var(--bufo-bg), rgba(17, 24, 39, 0.95)); }
    .role-civilian { border-color: var(--civilian); color: var(--civilian); background: radial-gradient(circle at top right, var(--civilian-bg), rgba(17, 24, 39, 0.95)); }

    .timer-circle {
        width: 220px; height: 220px; border-radius: 50%;
        border: 6px solid var(--surface-highlight);
        display: flex; align-items: center; justify-content: center;
        font-family: 'Outfit', monospace; font-size: 4rem; font-weight: 700;
        background: var(--surface);
    }

    .timer-running { border-color: var(--primary); color: var(--primary); animation: pulse 1s infinite alternate; }

    @keyframes pulse { from { box-shadow: 0 0 10px var(--primary-glow); } to { box-shadow: 0 0 30px var(--primary-glow); } }
    .hidden { display: none !important; }

    .tag { background: var(--surface-highlight); padding: 0.5rem 0.875rem; border-radius: 999px; font-size: 0.85rem; color: var(--text-muted); border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div class="glow-orb" style="top: -10%; left: -10%; background: #38bdf8;"></div>
    <div class="glow-orb" style="bottom: -10%; right: -10%; background: #d946ef;"></div>

    <div class="app-container">
        
        <header>
            <h1 class="gradient-text">IMPOSTOR</h1>
            <p class="subtitle">Desxifra • Enganya • Sobreviu</p>
        </header>

        <!-- PANTALLA 1: CONFIGURACIÓ -->
        <section id="setup-screen" class="screen active">
            <div class="glass-card">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label>Categoria (+1000 paraules)</label>
                    <select id="category-select" class="glass-input"></select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <label style="color:var(--impostor)">Impostors</label>
                        <span id="impostor-count-display" style="font-weight:bold;">1</span>
                    </div>
                    <input type="range" id="impostor-range" min="1" max="5" value="1" class="range-input">
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <label style="color:var(--bufo)">Bufons</label>
                        <span id="bufo-count-display" style="font-weight:bold;">0</span>
                    </div>
                    <input type="range" id="bufo-range" min="0" max="3" value="0" class="range-input">
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <label>Temps (seg)</label>
                        <span id="timer-display" style="font-weight:bold;">180s</span>
                    </div>
                    <input type="range" id="timer-range" min="60" max="600" step="30" value="180" class="range-input">
                </div>
            </div>

            <div class="bottom-action">
                <button id="btn-setup-next" class="btn primary">CONFIGURAR JUGADORS</button>
            </div>
        </section>

        <!-- PANTALLA 2: JUGADORS -->
        <section id="players-screen" class="screen">
            <div class="glass-card" style="padding:1rem; margin-bottom:1rem; flex-direction:row; justify-content:space-around;">
                <div style="text-align:center"><p class="subtitle" style="font-size:0.7rem">MÍNIM</p><strong id="min-players-req">3</strong></div>
                <div style="text-align:center"><p class="subtitle" style="font-size:0.7rem">ACTUALS</p><strong id="current-players-count">0</strong></div>
            </div>
            
            <div id="players-list" class="scroll-area"></div>

            <button id="btn-add-player" class="btn dashed">+ AFEGIR JUGADOR</button>
            
            <div class="bottom-action">
                <button id="btn-start-game" class="btn primary">COMENÇAR PARTIDA</button>
                <button id="btn-back-setup" class="btn secondary">ENRERE</button>
            </div>
        </section>

        <!-- PANTALLA 3: PASSA EL MÒBIL -->
        <section id="pass-screen" class="screen">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <p class="subtitle">PASSA EL MÒBIL A</p>
                <h2 id="current-player-name" class="gradient-text" style="font-size:3rem; margin:1.5rem 0;">Nom</h2>
                <button id="btn-reveal" class="btn primary" style="max-width:280px">VEURE EL MEU ROL</button>
            </div>
        </section>

        <!-- PANTALLA 4: REVELAR ROL -->
        <section id="reveal-screen" class="screen">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div id="role-card" class="glass-card role-card">
                    <p class="subtitle">EL TEU ROL ÉS</p>
                    <h2 id="role-title" class="role-title">ROL</h2>
                    <div class="divider"></div>
                    <div id="role-content"></div>
                    <p id="bufo-msg" class="hidden" style="margin-top:1rem; font-style:italic; opacity:0.9;">
                        Coneixes la paraula. Has de fer que et votin a tu sense fer-ho massa evident.
                    </p>
                </div>
            </div>
            <div class="bottom-action">
                <button id="btn-hide-pass" class="btn secondary">AMAGAR I CONTINUAR</button>
            </div>
        </section>

        <!-- PANTALLA 5: TEMPORITZADOR JOC -->
        <section id="game-screen" class="screen">
            <div style="display:flex; justify-content:center; margin:1.5rem 0;">
                <div class="timer-circle"><span id="game-timer">3:00</span></div>
            </div>
            <div style="display:flex; gap:0.5rem; margin-bottom:1.5rem;">
                <button id="btn-toggle-timer" class="btn primary" style="flex:2">PAUSA</button>
                <button id="btn-end-game" class="btn danger" style="flex:1">FI</button>
            </div>
            <div class="glass-card">
                <p class="subtitle" style="margin-bottom:1rem;">JUGADORS EN JOC</p>
                <div id="game-players-list" style="display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center;"></div>
            </div>
        </section>

    </div>

    <script>
        // --- BASE DE DADES ---
        const CATEGORIES = {
            "Animals": ["Gos", "Gat", "Elefant", "Lleó", "Tigre", "Girafa", "Mico", "Dofí", "Balena", "Àguila", "Pingüí", "Cangur", "Ós", "Llop", "Zebra", "Hipopòtam", "Rinoceront", "Cocodril", "Tortuga", "Granota", "Cavall", "Porc", "Vaca", "Ovella", "Gallina", "Ratolí", "Serp", "Tauró", "Papallona", "Abella", "Formiga", "Aranya", "Escorpí", "Llangardaix", "Camaleó", "Cranc", "Llagosta", "Polp", "Medusa", "Estrella de mar", "Cavallet de mar", "Flamenc", "Tucà", "Lloro", "Mussol", "Corb", "Cigne", "Ànec", "Paó", "Estruç", "Koala", "Panda", "Goril·la", "Ximpanzé", "Lleó marí", "Morsa", "Foca", "Nutria", "Castor", "Esquirol", "Ratpenat", "Talp", "Eriçó", "Conill", "Llebre", "Cérvol", "Ant", "Ren", "Búfal", "Bisó", "Toro", "Ase", "Mula", "Camell", "Dromedari", "Llama", "Alpaca", "Guepard", "Leopard", "Pantera", "Jaguar", "Lince", "Hiena", "Xacal", "Guineu", "Coiot", "Ós polar", "Ós bru", "Teixó", "Mofeta", "Fura", "Ermini", "Visó", "Suricata", "Lèmur", "Marmota", "Gòfer", "Hàmster", "Cobai", "Xinxilla", "Jerbu", "Porc espí", "Armadillo", "Pangolí", "Orycteropus", "Tapir", "Okapi", "Gaur", "Iak", "Mufló", "Isard", "Gamo", "Cabirol", "Senglar", "Pecarí", "Manatí", "Dugong"],
            "Menjar": ["Pizza", "Hamburguesa", "Sushi", "Paella", "Truita", "Espaguetis", "Amanida", "Pollastre", "Bistec", "Peix", "Gelat", "Pastís", "Xocolata", "Poma", "Plàtan", "Pa", "Formatge", "Pernil", "Ou", "Arròs", "Llenties", "Canelons", "Croquetes", "Sopa", "Iogurt", "Meló", "Maduixa", "Patates", "Ceba", "Tomàquet", "Alvocat", "Mango", "Pinya", "Raïm", "Cirera", "Pera", "Taronja", "Llimona", "Llima", "Síndria", "Préssec", "Albercoc", "Pruna", "Figa", "Kiwi", "Magrana", "Nabiu", "Gerds", "Mora", "Coco", "Nou", "Ametlla", "Avellana", "Cacauet", "Pistatxo", "Castaanya", "Dàtil", "Passes", "Pinyó", "Mel", "Sucre", "Sal", "Pebre", "Oli d'oliva", "Vinagre", "Mostassa", "Maionesa", "Quètxup", "Salsa de soja", "Curri", "Orenga", "Alfàbrega", "Julivert", "Romaní", "Farigola", "Safrà", "Canela", "Vainilla", "Cafè", "Te", "Llet", "Mantega", "Nata", "Formatge blau", "Parmesà", "Mozzarella", "Macarrons", "Lasanya", "Raviolis", "Risotto", "Cuscús", "Hummus", "Falàfel", "Kebab", "Taco", "Burrito", "Enchilada", "Nachos", "Guacamole", "Gaspatxo", "Salmorejo", "Fideuà", "Escudella", "Bacallà", "Llobarro", "Orada", "Salmó", "Truita de riu", "Sardina", "Boqueró", "Tonyina", "Gambes", "Llagostins", "Musclos", "Cloïsses", "Calamars", "Sípia", "Pop"],
            "Objectes": ["Taula", "Cadira", "Ordinador", "Telèfon", "Llibre", "Bolígraf", "Cotxe", "Bicicleta", "Rellotge", "Ulleres", "Sabata", "Motxilla", "Clau", "Bombeta", "Plat", "Got", "Forquilla", "Ganivet", "Cullera", "Mirall", "Llapis", "Tisores", "Ventilador", "Comandament", "Raspall", "Paraigua", "Escala", "Martell", "Llit", "Sofà", "Armari", "Estanteria", "Llum", "Quadre", "Catifa", "Cortina", "Finestra", "Porta", "Televisió", "Ràdio", "Altaveu", "Càmera", "Auriculars", "Tauleta", "Teclat", "Ratolí", "Monitor", "Impressora", "Escàner", "Consola", "Cable", "Endoll", "Bateria", "Pila", "Lot", "Espelma", "Mistu", "Encenedor", "Cendrer", "Ampolla", "Gerra", "Tassa", "Bol", "Paella", "Olla", "Cassola", "Colador", "Rallador", "Batedora", "Torradora", "Cafetera", "Microones", "Forn", "Nevera", "Congelador", "Rentavaixelles", "Rentadora", "Assecadora", "Planxa", "Aspiradora", "Escura", "Recollidor", "Cubell", "Fregona", "Drap", "Sabó", "Xampú", "Dentrífic", "Pinta", "Assecador", "Maquineta d'afaitar", "Maquillatge", "Perfum", "Joia", "Anell", "Collar", "Polsera", "Arracada", "Cartera", "Moneder", "Bossa", "Maleta", "Bastó", "Casc", "Guant", "Bufanda", "Gorret", "Barret", "Cinturó", "Corbata", "Mocador", "Abric", "Jaqueta", "Pantalons", "Camisa", "Samarreta"],
            "Llocs": ["Platja", "Muntanya", "Ciutat", "Poble", "Escola", "Hospital", "Parc", "Bosc", "Desert", "Selva", "Illa", "Castell", "Casa", "Botiga", "Aeroport", "Estació", "Cinema", "Teatre", "Museu", "Biblioteca", "Gimnàs", "Farmàcia", "Restaurant", "Mercat", "Església", "Universitat", "Zoo", "Lluna", "Mart", "Infern", "Cel", "Oceà", "Riu", "Llac", "Cascada", "Volcà", "Cova", "Vall", "Canó", "Penya-segat", "Far", "Port", "Pont", "Túnel", "Autopista", "Carrer", "Plaça", "Avinguda", "Gratacel", "Edifici", "Apartament", "Hotel", "Hostal", "Càmping", "Refugi", "Granja", "Hort", "Vinya", "Fàbrica", "Magatzem", "Oficina", "Banc", "Ajuntament", "Jutjat", "Presó", "Comissaria", "Estadi", "Poliesportiu", "Piscina", "Camp de futbol", "Parc d'atraccions", "Aquari", "Planetari", "Observatori", "Casino", "Discoteca", "Bar", "Pub", "Cafeteria", "Pastisseria", "Fleca", "Carnisseria", "Peixateria", "Supermercat", "Centre comercial", "Llibreria", "Quiosc", "Perruqueria", "Tintoreria", "Taller", "Benzinera", "Aparcament", "Cementiri", "Monestir", "Temple", "Mesquita", "Sinagoga", "Pagoda", "Piràmide", "Ruïnes", "Monument", "Palau", "Ambaixada", "Consolat", "Base militar", "Heliport", "Port espacial", "Estació d'autobusos", "Estació de tren", "Marina", "Moll"],
            "Ciència i Tecnologia": ["Àtom", "Molècula", "Cèl·lula", "ADN", "Proteïna", "Enzim", "Bacteri", "Virus", "Hormona", "Neurona", "Cervell", "Cor", "Pulmó", "Fetge", "Ronyó", "Os", "Múscul", "Pell", "Sang", "Gen", "Cromosoma", "Evolució", "Selecció natural", "Espècie", "Ecosistema", "Biodiversitat", "Clima", "Atmosfera", "Gravetat", "Magnetisme", "Electricitat", "Llum", "So", "Calor", "Energia", "Força", "Massa", "Velocitat", "Temps", "Espai", "Matèria", "Electró", "Protó", "Neutró", "Quark", "Fotó", "Llàser", "Radiació", "Fissió nuclear", "Fusió nuclear", "Relativitat", "Quàntica", "Big Bang", "Galàxia", "Estrella", "Planeta", "Satèl·lit", "Cometa", "Asteroide", "Meteorit", "Forat negre", "Telescopi", "Microscopi", "Satèl·lit artificial", "Coet", "Sonda espacial", "Estació espacial", "Robot", "Intel·ligència artificial", "Algoritme", "Programari", "Maquinari", "Internet", "Xarxa", "Servidor", "Base de dades", "Xifratge", "Blockchain", "Realitat virtual", "Realitat augmentada", "Impressió 3D", "Nanotecnologia", "Biotecnologia", "Energia solar", "Energia eòlica"],
            "Arts i Cultura": ["Pintura", "Escultura", "Arquitectura", "Música", "Dansa", "Teatre", "Cinema", "Literatura", "Poesia", "Fotografia", "Còmic", "Videojoc", "Disseny", "Moda", "Gastronomia", "Folklore", "Mitologia", "Religió", "Filosofia", "Història", "Arqueologia", "Antropologia", "Sociologia", "Psicologia", "Economia", "Política", "Dret", "Educació", "Llenguatge", "Escriptura", "Quadre", "Estàtua", "Catedral", "Simfonia", "Òpera", "Ballet", "Pel·lícula", "Novel·la", "Poema", "Assaig", "Biografia", "Diccionari", "Enciclopèdia", "Revista", "Diari", "Guió", "Partitura", "Pinzell", "Cincell", "Piano", "Guitarra", "Violí", "Flauta", "Trompeta", "Bateria", "Veu", "Micròfon", "Escenari", "Museu", "Auditori", "Conservatori", "Acadèmia", "Festival", "Premi", "Exposició", "Subhasta", "Crítica", "Estètica", "Renaixement", "Barroc", "Il·lustració", "Romanticisme", "Impressionisme", "Surrealisme", "Cubisme", "Art pop", "Minimalisme", "Art contemporani", "Patrimoni de la Humanitat", "Tradició", "Llegenda", "Conte", "Faula"],
            "Esports": ["Futbol", "Bàsquet", "Tennis", "Ciclisme", "Natació", "Atletisme", "Gimnàstica", "Handbol", "Voleibol", "Rugbi", "Béisbol", "Golf", "Hoquei", "Boxa", "Judo", "Karate", "Esquí", "Snowboard", "Surf", "Vela", "Rem", "Piragüisme", "Escalada", "Senderisme", "Motociclisme", "Automobilisme", "Escacs", "Billar", "Dards", "Ping-pong", "Pilota", "Raqueta", "Bicicleta", "Patins", "Taula de surf", "Esquís", "Casc", "Guants", "Botes", "Samarreta", "Xandall", "Banyador", "Xarxa", "Porteria", "Cistella", "Camp", "Pista", "Estadi", "Gimnàs", "Piscina", "Circuit", "Àrbitre", "Entrenador", "Jugador", "Equip", "Club", "Lliga", "Campionat", "Medalla", "Trofeu", "Copa", "Rècord", "Gol", "Punt", "Set", "Marató", "Triatló", "Jocs Olímpics", "Mundial", "Torneig", "Entrenament", "Dieta", "Fair play", "Afició", "Banqueta", "Vestuari", "Fitxatge", "Traspàs", "Retirada", "Victoria", "Derrota"],
            "Mix Complet": []
        };

        (function setupMix() {
            let all = [];
            Object.keys(CATEGORIES).forEach(k => { if(k !== "Mix Complet") all.push(...CATEGORIES[k]); });
            CATEGORIES["Mix Complet"] = [...new Set(all)]; // Elimina duplicats
        })();

        // --- ESTAT DEL JOC ---
        let gameState = {
            settings: { category: "Mix Complet", numImpostors: 1, numBufos: 0, timeSeconds: 180 },
            players: [],
            currentPlayerIndex: 0,
            secretWord: "",
            timeLeft: 0,
            timerInterval: null,
            isPaused: false
        };

        const screens = {
            setup: document.getElementById('setup-screen'),
            players: document.getElementById('players-screen'),
            pass: document.getElementById('pass-screen'),
            reveal: document.getElementById('reveal-screen'),
            game: document.getElementById('game-screen')
        };

        function init() {
            const catSelect = document.getElementById('category-select');
            Object.keys(CATEGORIES).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.innerText = `${cat} (${CATEGORIES[cat].length})`;
                catSelect.appendChild(opt);
            });
            catSelect.value = "Mix Complet";

            // Controls sliders
            document.getElementById('impostor-range').oninput = (e) => {
                document.getElementById('impostor-count-display').innerText = e.target.value;
                gameState.settings.numImpostors = parseInt(e.target.value);
                updateMinPlayersRequirement();
            };
            document.getElementById('bufo-range').oninput = (e) => {
                document.getElementById('bufo-count-display').innerText = e.target.value;
                gameState.settings.numBufos = parseInt(e.target.value);
                updateMinPlayersRequirement();
            };
            document.getElementById('timer-range').oninput = (e) => {
                document.getElementById('timer-display').innerText = e.target.value + 's';
                gameState.settings.timeSeconds = parseInt(e.target.value);
            };

            // Botons navegació
            document.getElementById('btn-setup-next').onclick = () => {
                const req = getMinPlayers();
                const currentInputs = document.querySelectorAll('.player-name-input').length;
                if(currentInputs < req) for(let i = currentInputs; i < req; i++) addPlayerInput();
                showScreen('players');
            };
            document.getElementById('btn-back-setup').onclick = () => showScreen('setup');
            document.getElementById('btn-add-player').onclick = addPlayerInput;
            document.getElementById('btn-start-game').onclick = startGameLogic;
            document.getElementById('btn-reveal').onclick = showRole;
            document.getElementById('btn-hide-pass').onclick = nextTurn;
            document.getElementById('btn-toggle-timer').onclick = toggleTimer;
            document.getElementById('btn-end-game').onclick = resetGame;

            // Inici amb 3 slots
            for(let i=0; i<3; i++) addPlayerInput();
            updateMinPlayersRequirement();
        }

        function showScreen(n) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[n].classList.add('active');
            window.scrollTo(0,0);
        }

        function getMinPlayers() {
            return Math.max(3, gameState.settings.numImpostors + gameState.settings.numBufos + 1);
        }

        function updateMinPlayersRequirement() {
            document.getElementById('min-players-req').innerText = getMinPlayers();
            updateCurrentPlayerCount();
        }

        function updateCurrentPlayerCount() {
            document.getElementById('current-players-count').innerText = document.querySelectorAll('.player-name-input').length;
        }

        function addPlayerInput() {
            const list = document.getElementById('players-list');
            const div = document.createElement('div');
            div.className = 'player-input-row';
            div.innerHTML = `
                <input type="text" class="glass-input player-name-input" placeholder="Jugador ${list.children.length + 1}">
                <div class="btn-remove">✕</div>
            `;
            div.querySelector('.btn-remove').onclick = () => { div.remove(); updateCurrentPlayerCount(); };
            list.appendChild(div);
            updateCurrentPlayerCount();
        }

        // --- LÒGICA D'ALEATORIETAT I MEMÒRIA ---

        /** Algoritme Fisher-Yates per a una barreja perfecta */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[array.length - 1 - i]] = [array[array.length - 1 - i], array[i]]; // Barreja extra
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGameLogic() {
            const inputs = document.querySelectorAll('.player-name-input');
            const playerNames = Array.from(inputs).map(i => i.value.trim() || i.placeholder);
            const minReq = getMinPlayers();

            if (playerNames.length < minReq) return alert(`Necessites almenys ${minReq} jugadors.`);

            // Recuperem l'últim impostor de localStorage
            const lastImpostors = JSON.parse(localStorage.getItem('impostor_history') || '[]');
            
            // Creem l'estructura d'objectes de jugadors
            let playersData = playerNames.map(name => ({ name: name, role: 'CIVILIAN' }));

            // 1. Decidir quins índexs poden ser impostors (evitant els últims si és possible)
            let possibleImpostorIndices = [];
            playersData.forEach((p, index) => {
                if (!lastImpostors.includes(p.name)) {
                    possibleImpostorIndices.push(index);
                }
            });

            // Si tothom va ser impostor o el grup és petit, permetem repetir
            if (possibleImpostorIndices.length < gameState.settings.numImpostors) {
                possibleImpostorIndices = playersData.map((_, i) => i);
            }

            // Barrejar els candidats a impostor
            shuffle(possibleImpostorIndices);
            
            // 2. Assignar Impostors
            let chosenImpostorNames = [];
            for (let i = 0; i < gameState.settings.numImpostors; i++) {
                const idx = possibleImpostorIndices.pop();
                playersData[idx].role = 'IMPOSTOR';
                chosenImpostorNames.push(playersData[idx].name);
            }

            // 3. Assignar Bufons entre els que queden
            let remainingIndices = playersData
                .map((p, i) => p.role === 'CIVILIAN' ? i : -1)
                .filter(i => i !== -1);
            
            shuffle(remainingIndices);
            for (let i = 0; i < gameState.settings.numBufos; i++) {
                if (remainingIndices.length > 0) {
                    const idx = remainingIndices.pop();
                    playersData[idx].role = 'BUFO';
                }
            }

            // 4. Desar els nous impostors al localStorage per a la propera partida
            localStorage.setItem('impostor_history', JSON.stringify(chosenImpostorNames));

            // Escollir paraula secreta
            const currentCat = document.getElementById('category-select').value;
            const words = CATEGORIES[currentCat];
            gameState.secretWord = words[Math.floor(Math.random() * words.length)];

            // Finalitzar estat
            gameState.players = playersData;
            gameState.currentPlayerIndex = 0;
            
            updatePassScreen();
            showScreen('pass');
        }

        function updatePassScreen() {
            document.getElementById('current-player-name').innerText = gameState.players[gameState.currentPlayerIndex].name;
        }

        function showRole() {
            const p = gameState.players[gameState.currentPlayerIndex];
            const card = document.getElementById('role-card');
            const title = document.getElementById('role-title');
            const content = document.getElementById('role-content');
            const bufoMsg = document.getElementById('bufo-msg');

            card.classList.remove('role-impostor', 'role-bufo', 'role-civilian');
            bufoMsg.classList.add('hidden');

            if (p.role === 'IMPOSTOR') {
                card.classList.add('role-impostor'); 
                title.innerText = "IMPOSTOR";
                content.innerHTML = '<p style="font-size:1.1rem">No saps la paraula secreta.<br><br>Escolta els altres i intenta passar desapercebut o endevinar de què parlen.</p>';
            } else if (p.role === 'BUFO') {
                card.classList.add('role-bufo'); 
                title.innerText = "BUFÓ";
                content.innerHTML = `<p class="subtitle">LA PARAULA ÉS:</p><p class="word-display">${gameState.secretWord}</p>`;
                bufoMsg.classList.remove('hidden');
            } else {
                card.classList.add('role-civilian'); 
                title.innerText = "CIUTADÀ";
                content.innerHTML = `<p class="subtitle">LA PARAULA ÉS:</p><p class="word-display">${gameState.secretWord}</p>`;
            }
            showScreen('reveal');
        }

        function nextTurn() {
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                initGameRound();
            } else {
                updatePassScreen();
                showScreen('pass');
            }
        }

        function initGameRound() {
            gameState.timeLeft = gameState.settings.timeSeconds;
            updateTimerDisplay();
            const container = document.getElementById('game-players-list');
            container.innerHTML = '';
            gameState.players.forEach(p => {
                const tag = document.createElement('span'); 
                tag.className = 'tag'; 
                tag.innerText = p.name; 
                container.appendChild(tag);
            });
            showScreen('game');
            startTimer();
        }

        function startTimer() {
            gameState.isPaused = false;
            document.getElementById('btn-toggle-timer').innerText = "PAUSA";
            document.querySelector('.timer-circle').classList.add('timer-running');
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                if (gameState.timeLeft <= 0) { 
                    clearInterval(gameState.timerInterval); 
                    document.querySelector('.timer-circle').classList.remove('timer-running');
                    alert("S'ha acabat el temps! Moment de votar l'impostor."); 
                }
            }, 1000);
        }

        function toggleTimer() {
            if (!gameState.isPaused) {
                clearInterval(gameState.timerInterval); 
                gameState.isPaused = true;
                document.getElementById('btn-toggle-timer').innerText = "CONTINUAR";
                document.querySelector('.timer-circle').classList.remove('timer-running');
            } else { startTimer(); }
        }

        function updateTimerDisplay() {
            const m = Math.floor(gameState.timeLeft / 60), s = gameState.timeLeft % 60;
            document.getElementById('game-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function resetGame() { 
            clearInterval(gameState.timerInterval); 
            showScreen('setup'); 
        }

        init();
    </script>
</body>
</html>
